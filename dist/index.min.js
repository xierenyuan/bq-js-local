!function(e){"use strict";function t(){R=!0;for(var e,t,n=C.length;n;){for(t=C,C=[],e=-1;++e<n;)t[e]();n=C.length}R=!1}function n(e){1!==C.push(e)||R||x()}function r(){}function o(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=L,this.queue=[],this.outcome=void 0,e!==r&&c(this,e)}function i(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function u(e,t,n){O(function(){var r;try{r=t(n)}catch(t){return D.reject(e,t)}r===e?D.reject(e,new TypeError("Cannot resolve promise with itself")):D.resolve(e,r)})}function a(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function c(e,t){function n(t){i||(i=!0,D.reject(e,t))}function r(t){i||(i=!0,D.resolve(e,t))}function o(){t(r,n)}var i=!1,u=s(o);"error"===u.status&&n(u.value)}function s(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}function l(e){return e instanceof this?e:D.resolve(new this(r),e)}function f(e){var t=new this(r);return D.reject(t,e)}function h(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,o=!1;if(!n)return this.resolve([]);for(var i=new Array(n),u=0,a=-1,c=new this(r);++a<n;)!function(e,r){function a(e){i[r]=e,++u!==n||o||(o=!0,D.resolve(c,i))}t.resolve(e).then(a,function(e){o||(o=!0,D.reject(c,e))})}(e[a],a);return c}function p(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,o=!1;if(!n)return this.resolve([]);for(var i=-1,u=new this(r);++i<n;)!function(e){t.resolve(e).then(function(e){o||(o=!0,D.resolve(u,e))},function(e){o||(o=!0,D.reject(u,e))})}(e[i]);return u}function d(e,t){if(M(e)){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n++)t(e[n],n,e)}else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(e[r],r)}function v(e,t){return d(t,function(n,r){e[r]||(e[r]=t[r])}),e}function y(e){var t=this,n=e+"__";this.init=function(){return H.resolve()},this.remove=function(e){return localStorage.removeItem(n+e),H.resolve()},this.set=function(e,r,o){var i={value:r,expire:o};return new H(function(r,o){try{localStorage.setItem(n+e,JSON.stringify(i)),r()}catch(u){if(u.name.toUpperCase().indexOf("QUOTA")>=0)try{d(localStorage,function(e,r){var o=r.split(n)[1];o&&t.remove(o)}),localStorage.setItem(n+e,JSON.stringify(i)),r()}catch(e){o(e)}else o(u)}})},this.get=function(e,t){return new H(function(r,o){try{var i=localStorage.getItem(n+e);if(null===i)return r();i=JSON.parse(localStorage.getItem(n+e)),r(i=t?i:i.value)}catch(t){o(new Error("Can't read key: "+e))}})},this.clear=function(e){var r=+new Date,o=H.resolve();return d(localStorage,function(i,u){var a=u.split(n)[1];if(a)return e?void(o=o.then(function(){return t.get(a,!0).then(function(e){e&&e.expire>0&&e.expire-r<0&&t.remove(a)})})):void(o=o.then(function(){t.remove(a)}))}),o}}function g(e){var t;this.init=function(){return new H(function(n,r){if(!(t=window.openDatabase(e,"1.0","bag.js db",2e5)))return void r("Can't open websql database");t.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS kv (key TEXT PRIMARY KEY, value TEXT, expire INTEGER KEY)",[],function(){n()},function(e,t){r(t)})})})},this.remove=function(e){return new H(function(n,r){t.transaction(function(t){t.executeSql("DELETE FROM kv WHERE key = ?",[e],function(){n()},function(e,t){r(t)})})})},this.set=function(e,n,r){return new H(function(o,i){t.transaction(function(t){t.executeSql("INSERT OR REPLACE INTO kv (key, value, expire) VALUES (?, ?, ?)",[e,JSON.stringify(n),r],function(){o()},function(e,t){i(t)})})})},this.get=function(e){return new H(function(n,r){t.readTransaction(function(t){t.executeSql("SELECT value FROM kv WHERE key = ?",[e],function(e,t){if(0===t.rows.length)return n();var o=t.rows.item(0).value;try{n(JSON.parse(o))}catch(e){r(new Error("Can't unserialise data: "+o))}},function(e,t){r(t)})})})},this.clear=function(e){return new H(function(n,r){t.transaction(function(t){t.executeSql(e?"DELETE FROM kv WHERE expire > 0 AND expire < ?":"DELETE FROM kv",e?[+new Date]:[],function(){n()},function(e,t){r(t)})})})}}function m(e){var t;this.init=function(){return new H(function(n,r){var o=window.indexedDB,i=o.open(e,2);i.onsuccess=function(e){t=e.target.result,n()},i.onblocked=function(e){r(new Error("IndexedDB blocked. "+e.target.errorCode))},i.onerror=function(e){r(new Error("IndexedDB opening error. "+e.target.errorCode))},i.onupgradeneeded=function(e){t=e.target.result,t.objectStoreNames.contains("kv")&&t.deleteObjectStore("kv"),t.createObjectStore("kv",{keyPath:"key"}).createIndex("expire","expire",{unique:!1})}})},this.remove=function(e){return new H(function(n,r){var o=t.transaction("kv","readwrite");o.oncomplete=function(){n()},o.onerror=o.onabort=function(e){r(e.target)},o.objectStore("kv").delete(e).onerror=function(){o.abort()}})},this.set=function(e,n,r){return new H(function(o,i){var u=t.transaction("kv","readwrite");u.oncomplete=function(){o()},u.onerror=u.onabort=function(e){i(e.target)},u.objectStore("kv").put({key:e,value:n,expire:r}).onerror=function(){u.abort()}})},this.get=function(e){return new H(function(n,r){var o=t.transaction("kv");o.onerror=o.onabort=function(e){r(new Error("Key get error: "+e.target))},o.objectStore("kv").get(e).onsuccess=function(e){e.target.result?n(e.target.result.value):n()}})},this.clear=function(e){return new H(function(n,r){var o=window.IDBKeyRange,i=t.transaction("kv","readwrite"),u=i.objectStore("kv");if(i=t.transaction("kv","readwrite"),u=i.objectStore("kv"),i.oncomplete=function(){n()},i.onerror=i.onabort=function(e){r(new Error("Clear error: ",e.target))},e){return void(u.index("expire").openCursor(o.bound(1,+new Date)).onsuccess=function(e){var t=e.target.result;t&&(u.delete(t.primaryKey).onerror=function(){i.abort()},t.continue())})}i.objectStore("kv").clear().onerror=function(){i.abort()}})}}function w(e,t){function n(){return H.resolve().then(function(){if(!r)throw new Error("No available db");return r.init().then(function(){r.clear(!0)})})}var r=null;d(t,function(n){if(n=n.toLowerCase(),!U[n])throw new Error("Wrong storage adapter name: "+n,t);if(U[n].exists()&&!r)return r=new U[n](e),!1}),r||"undefined"!=typeof console&&console.log&&console.log("None of requested storages available: "+t);var o;this.init=function(){return o||(o=n()),o},this.set=function(e,t,n){return this.init().then(function(){return r.set(e,t,n?+new Date+1e3*n:0)})},this.get=function(e){return this.init().then(function(){return r.get(e)})},this.remove=function(e){return this.init().then(function(){return r.remove(e)})},this.clear=function(e){return this.init().then(function(){return r.clear(e)})}}function b(e){function t(){f||(f=new w(l.prefix,l.stores))}function n(e){return new H(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?t({content:r.responseText,type:r.getResponseHeader("content-type")}):n(new Error("Can't open url "+e+(r.status?r.statusText+" ("+r.status+")":""))))},setTimeout(function(){r.readyState<4&&(r.abort(),n(new Error("Timeout")))},1e3*l.timeout);try{r.send()}catch(e){n(e)}})}function r(e,t){var n={};d(["url","key","unique"],function(t){e[t]&&(n[t]=e[t])});var r=+new Date;return n.data=t.content,n.originalType=t.type,n.type=e.type||t.type,n.stamp=r,n}function o(e){return n(e.url_real).then(function(t){var n=60*(e.expire||l.expire)*60,o=r(e,t);return f.set(e.key,o,n).then(function(){return v(e,o)},function(){return v(e,o)})})}function i(e,t){return!e||e.expire-+new Date<0||t.unique!==e.unique||t.url!==e.url||l.isValidItem&&!l.isValidItem(e,t)}function u(e){return e.url?(e.key=e.key||e.url,f.get(e.key).then(function(e){return e},function(){return null}).then(function(t){if(!t&&e.cached)throw new Error("Cache not exists");e.execute=!1!==e.execute;var n=!t||i(t,e);return e.live||n?(e.url_real=e.url,e.unique&&(e.url_real=e.url+(e.url.indexOf("?")>0?"&":"?")+"bag-unique="+e.unique),o(e).then(function(){return e},function(n){if(!t)throw n;return e.type=e.type||t.originalType,v(e,t)})):(e.type=e.type||t.originalType,v(e,t))})):H.resolve()}function a(e){var t=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),n=e.match(t);return{scheme:n[2],authority:n[4],path:n[5],query:n[7],fragment:n[9]}}function c(e){var t=a(e.url),n=!1,r=e.data.replace(h,function(e,r,o,i,u,c,s){if(!e)return null;n=!0,r||(r=u,o=c,i=s);var l=a(o);return r+(((l.scheme?l.scheme:t.scheme)||window.location.protocol.slice(0,-1))+"://")+((l.authority?l.authority:t.authority)||window.location.host)+("/"===l.path[0]?l.path:t.path.split("/").slice(0,-1).join("/")+"/"+l.path)+i});return n?r:""}function s(e){if(e.type){var t=e.type.split(";")[0];"application/x-javascript"!==t&&"text/javascript"!==t||(t="application/javascript"),p[t]&&p[t](e)}}if(!(this instanceof b))return new b(e);var l=this;e=e||{},this.prefix=e.prefix||"bag",this.timeout=e.timeout||20,this.expire=e.expire||720,this.isValidItem=e.isValidItem||null,this.stores=M(e.stores)?e.stores:["indexeddb","websql","localstorage"];var f=null,h=/(?:^([ \t]*\/\/[@|#][ \t]+sourceMappingURL=)(.+?)([ \t]*)$)|(?:^([ \t]*\/\*[@#][ \t]+sourceMappingURL=)(.+?)([ \t]*\*\/[ \t])*$)/gm,p={"application/javascript":function(e){var t,n=document.createElement("script");t=c(e),t||(t=e.data+"\n//# sourceURL="+e.url),n.text=t,F.appendChild(n)},"text/css":function(e){var t,n=document.createElement("style");t=c(e),t||(t=e.data+"\n/*# sourceURL="+e.url+" */"),n.setAttribute("type","text/css"),n.styleSheet?(F.appendChild(n),n.styleSheet.cssText=t):(n.appendChild(document.createTextNode(t)),F.appendChild(n))}};this.require=function(e){return t(),new H(function(t,n){var r=[],o=0,i=M(e)?e:[e];if(!e)return void t();d(i,function(e,t){r[t]=!1}),d(i,function(a,c){"string"==typeof a&&(i[c]={url:a}),u(i[c]).then(function(){r[c]=i[c].data;var n;for(n=o;n<r.length&&!1!==r[n];n++)i[n].execute&&s(i[n]);(o=n)>=i.length&&t(M(e)?r:r[0])},function(e){n(e)})})})},d(["remove","get","set","clear"],function(e){l[e]=function(){return t(),f[e].apply(f,arguments)}}),this.addHandler=function(e,t){e=M(e)?e:[e],d(e,function(e){p[e]=t})},this.removeHandler=function(e){l.addHandler(e)}}function E(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:B,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{prefix:"bq_local",stores:["indexeddb","websql","localstorage"],expire:1},n=e.lazyload||[],r=e.doc||document,o=e.tag||"noscript";r.querySelectorAll(o).forEach(function(e){(new DOMParser).parseFromString(e.childNodes[0].nodeValue,"text/html").querySelectorAll("script").forEach(function(e){n.push(e.getAttribute("src"))})});var i=new b(t);return{lazyLoad:n,require:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n;return i.require(e)},clear:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return i.clear(e)},remove:function(e){return i.remove(e)},get:function(e){return i.get(e)},set:function(e,t,n){return i.set(e,t,n)}}}var x,j="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},S=j.MutationObserver||j.WebKitMutationObserver;if(S){var k=0,T=new S(t),q=j.document.createTextNode("");T.observe(q,{characterData:!0}),x=function(){q.data=k=++k%2}}else if(j.setImmediate||void 0===j.MessageChannel)x="document"in j&&"onreadystatechange"in j.document.createElement("script")?function(){var e=j.document.createElement("script");e.onreadystatechange=function(){t(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},j.document.documentElement.appendChild(e)}:function(){setTimeout(t,0)};else{var _=new j.MessageChannel;_.port1.onmessage=t,x=function(){_.port2.postMessage(0)}}var R,C=[],O=n,D={},I=["REJECTED"],N=["FULFILLED"],L=["PENDING"],A=o;o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){if("function"!=typeof e&&this.state===N||"function"!=typeof t&&this.state===I)return this;var n=new this.constructor(r);if(this.state!==L){u(n,this.state===N?e:t,this.outcome)}else this.queue.push(new i(n,e,t));return n},i.prototype.callFulfilled=function(e){D.resolve(this.promise,e)},i.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},i.prototype.callRejected=function(e){D.reject(this.promise,e)},i.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},D.resolve=function(e,t){var n=s(a,t);if("error"===n.status)return D.reject(e,n.value);var r=n.value;if(r)c(e,r);else{e.state=N,e.outcome=t;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(t)}return e},D.reject=function(e,t){e.state=I,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e},o.resolve=l,o.reject=f,o.all=h,o.race=p;var F=document.head||document.getElementsByTagName("head")[0],M=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},H=A;y.exists=function(){try{return localStorage.setItem("__ls_test__","__ls_test__"),localStorage.removeItem("__ls_test__"),!0}catch(e){return!1}},g.exists=function(){return!!window.openDatabase},m.exists=function(){var e=window.indexedDB;if(!e)return!1;var t=null===e.open("__idb_test__",1).onupgradeneeded;return e.deleteDatabase&&e.deleteDatabase("__idb_test__"),t};var U={indexeddb:m,websql:g,localstorage:y},B={tag:["noscript"],lazyload:["//cdnjs.gtimg.com/cdnjs/libs/zepto/1.1.4/zepto.min.js"],doc:document};e.init=E}(this.bqLocal=this.bqLocal||{});
